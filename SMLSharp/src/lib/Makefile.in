srcdir = @srcdir@
builddir = @builddir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

include @top_builddir@/commonrule

SUBDIRS = basis \
	  FFI \
	  LMLML \
	  Script \
	  SMLSharp \
          CConfig

VPATH = @srcdir@

TARGETS = prelude.smk @NATIVE_PRELUDE@

GENSOURCES =

# ./ is required to avoid PATH substitution on Solaris make.
INSTALL_FILES = ./basis \
                ./basis.sml \
                ./FFI \
                ./FFI.sml \
		./LMLML.sml \
		./LMLML \
                ./minimum \
                ./minimum.sml \
                ./ml-yacc \
                ./ml-yacc-lib.sml \
		./prelude.sml \
		./Script \
		./script.sml \
                ./SMLNJ \
		./CConfig \
		./SMLSharp \
		./SMLSharp.sml

all: $(TARGETS)

clean:
	-rm -f $(srcdir)/CM
	-rm -f $(TARGETS) $(GENSOURCES)

mlton: config

install: $(TARGETS)
	$(INSTALL) -m 755 -d '$(DESTDIR)$(libdir_smlsharp)'
	$(INSTALL_DATA) prelude.sme '$(DESTDIR)$(libdir_smlsharp)'
	$(INSTALL_DATA) prelude.smk '$(DESTDIR)$(libdir_smlsharp)'
	[ -z "@NATIVE_PRELUDE@" ] || \
	$(INSTALL_DATA) ntprelude.$(OBJEXT) '$(DESTDIR)$(libdir_smlsharp)'
	[ -z "@NATIVE_PRELUDE@" ] || \
	$(INSTALL_DATA) ntprelude.smk '$(DESTDIR)$(libdir_smlsharp)'
	@set -x; \
	cd $(srcdir); \
	find $(INSTALL_FILES) -type d -print \
	| $(EGREP) -v '\.svn|CVS' \
	| (while read i; do \
	    $(INSTALL) -m 755 -d '$(DESTDIR)$(libdir_smlsharp)/'$$i \
	    || exit $$?; \
	done)
	@set -x; \
	cd $(srcdir); \
	find $(INSTALL_FILES) -type f -print \
	| $(EGREP) -v '\.svn|CVS|\.cvsignore|\~$$|\.in$$|Makefile' \
	| (while read i; do \
	    $(INSTALL_DATA) $$i '$(DESTDIR)$(libdir_smlsharp)/'$$i \
	    || exit $$?; \
	done)

# ToDO : 
# prelude depends on many files in Basis and other libraries.
prelude.smk: rtprelude.sml prelude.sml $(GENSOURCES) $(SMLSHARP)
	$(SMLSHARP) --make-prelude -noprelude -target='' rtprelude.sml -o prelude.sme

ntprelude.smk: yaprelude.sml prelude.sml $(GENSOURCES) $(SMLSHARP)
	$(SMLSHARP) --make-prelude -noprelude -dtraceFileLoad=yes yaprelude.sml -o ntprelude.o
