srcdir = @srcdir@
builddir = @builddir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

include @top_builddir@/commonrule

VPATH = @srcdir@

PPGFILES = $(srcdir)/insndef.ppg
YACCFILES = $(srcdir)/insndef.grm
LEXFILES = $(srcdir)/insndef.lex

GENSOURCES = $(PPGFILES:.ppg=.ppg.sml) \
             $(YACCFILES:.grm=.grm.sml) \
             $(YACCFILES:.grm=.grm.sig) \
             $(YACCFILES:.grm=.grm.desc) \
             $(LEXFILES:.lex=.lex.sml)

TARGETS = $(srcdir)/VMMnemonic.sml \
          $(srcdir)/VMMnemonicFormatterFn.sml \
          $(srcdir)/VMMnemonicParserFn.sml \
          $(srcdir)/VMMnemonicAssemblerFn32.sml \
          $(srcdir)/VMMnemonicAssemblerFn64.sml \
          $(srcdir)/prep32.inc \
          $(srcdir)/prep64.inc \
          $(srcdir)/ops32.inc \
          $(srcdir)/ops64.inc \
          $(srcdir)/optab32.inc \
          $(srcdir)/optab64.inc

SOURCES = control.sml \
          utils.sml \
          parser.sml \
          elab.sml \
          subst.sml \
          typecheck.sml \
          mother.sml \
          fusion.sml \
          ml-mnemonic-gen.sml \
          ml-parser-gen.sml \
          ml-printer-gen.sml \
          ml-asm-gen.sml \
          c-prep-gen.sml \
          c-eval-gen.sml \
          main.sml \
          start.sml \
          $(GENSOURCES)

all: $(TARGETS)

$(TARGETS): vmgen $(GENSOURCES) $(srcdir)/insn.def
	./vmgen $(srcdir) insn.def

vmgen: sources.cm $(SOURCES)
	$(MAKESML) -o $@ $(srcdir)/sources.cm

clean:
	-rm -rf $(srcdir)/CM $(srcdir)/.cm
	-rm -f $(TARGETS)
	-rm -f $(GENSOURCES)
	-rm -f insndef.grm.sml insndef.grm.sig insndef.grm.desc insndef.lex.sml
	$(MAKESML) -r -o vmgen

$(srcdir)/insndef.ppg.sml: insndef.ppg
$(srcdir)/insndef.grm.sml $(srcdir)/insndef.grm.sig $(srcdir)/insndef.grm.desc: insndef.grm
$(srcdir)/insndef.lex.sml: insndef.lex
