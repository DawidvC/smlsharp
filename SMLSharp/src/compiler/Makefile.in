srcdir = @srcdir@
builddir = @builddir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

include @top_builddir@/commonrule

VPATH = @srcdir@

# FIXME: all generating files should be placed in builddir, not in srcdir.

TARGETS = smlsharp

SOURCES = $(srcdir)/absyn/main/Absyn.ppg \
          $(srcdir)/absyn/main/AbsynInterface.ppg \
          $(srcdir)/absyn/main/AbsynSQL.ppg \
          $(srcdir)/anormal/main/ANormal.ppg \
          $(srcdir)/annotatedtypes/main/AnnotatedTypes.ppg \
          $(srcdir)/annotatedcalc/main/AnnotatedCalc.ppg \
          $(srcdir)/assemble/main/AssembleError.ppg \
          $(srcdir)/builtin/main/BuiltinPrimitive.ppg \
          $(srcdir)/builtin/main/BuiltinType.ppg \
          $(srcdir)/builtin/main/BuiltinContextCore.smi.sml \
          $(srcdir)/builtin/main/BuiltinContextSQL.smi.sml \
          $(srcdir)/idcalc/main/IDCalc.ppg \
          $(srcdir)/nameevaluation/main/NameEvalError.ppg \
          $(srcdir)/nameevaluation/main/NameEvalEnv.ppg \
          $(srcdir)/bitmapanormal/main/BitmapANormal.ppg \
          $(srcdir)/bitmapcalc/main/BitmapCalc.ppg \
          $(srcdir)/closureanormal/main/ClosureANormal.ppg \
          $(srcdir)/control/main/Control.ppg \
          $(srcdir)/control/main/Loc.ppg \
          $(srcdir)/usererror/main/UserError.ppg \
          $(srcdir)/clustercalc/main/ClusterCalc.ppg \
          $(srcdir)/elaborate/main/ElaborateError.ppg \
          $(srcdir)/elaborate/main/ElaborateErrorSQL.ppg \
          $(srcdir)/util/main/SmlppgUtil.ppg \
          $(srcdir)/functionlocalize/main/FunIDMapData.ppg \
          $(srcdir)/generatemain/main/GenerateMainError.ppg \
          $(srcdir)/intermediatelanguage/main/IntermediateLanguage.ppg \
          $(srcdir)/loadfile/main/LoadFileError.ppg \
          $(srcdir)/matchcompilation/main/MatchError.ppg \
          $(srcdir)/multiplevaluecalc/main/MultipleValueCalc.ppg \
          $(srcdir)/multiplevaluecalc/main/MVTypeCheckError.ppg \
          $(srcdir)/patterncalc/main/PatternCalc.ppg \
          $(srcdir)/patterncalc/main/PatternCalcInterface.ppg \
          $(srcdir)/parser/main/ParserError.ppg \
          $(srcdir)/recordcalc/main/RecordCalc.ppg \
          $(srcdir)/symbolicinstructions/main/SymbolicInstructions.ppg \
          $(srcdir)/typedcalc/main/TypedCalc.ppg \
          $(srcdir)/typedlambda/main/TypeCheckTypedLambdaError.ppg \
          $(srcdir)/typedlambda/main/TypedLambda.ppg \
          $(srcdir)/typeinference2/main/TypeInferenceError.ppg \
          $(srcdir)/typeinference2/main/TypeInferenceContext.ppg \
          $(srcdir)/constantterm/main/ConstantTerm.ppg \
          $(srcdir)/runtimetypes/main/RuntimeTypes.ppg \
          $(srcdir)/types/main/IDTypes.ppg \
          $(srcdir)/types/main/Types.ppg \
          $(srcdir)/yaanormal/main/ANormal.ppg \
          $(srcdir)/yaanormal/main/ANormalTypeCheckError.ppg \
          $(srcdir)/abstractinstruction2/main/AbstractInstruction.ppg \
          $(srcdir)/rtl/main/X86Asm.ppg \
          $(srcdir)/rtl/main/RTL.ppg \
          $(srcdir)/rtl/main/RTLTypeCheckError.ppg

YACCFILES = $(srcdir)/parser/main/iml.grm \
            $(srcdir)/parser/main/interface.grm
LEXFILES  = $(srcdir)/parser/main/iml.lex

GENSOURCES = $(SOURCES:.ppg=.ppg.sml) \
             $(YACCFILES:.grm=.grm.sml) \
             $(YACCFILES:.grm=.grm.sig) \
             $(YACCFILES:.grm=.grm.desc) \
             $(LEXFILES:.lex=.lex.sml)

all: $(TARGETS)

clean:
	-rm -f $(TARGETS) $(GENSOURCES)
	-rm -rf `$(FIND) $(srcdir) -name "CM" -type d -print`
	-rm -rf `$(FIND) $(srcdir) -name ".cm" -type d -print`
	-rm -f $(srcdir)/parser/main/iml.grm.sml
	-rm -f $(srcdir)/parser/main/iml.grm.desc
	-rm -f $(srcdir)/parser/main/iml.grm.sig
	-rm -f $(srcdir)/parser/main/iml.lex.sml
	-rm -f $(srcdir)/parser/main/interface.grm.sml
	-rm -f $(srcdir)/parser/main/interface.grm.desc
	-rm -f $(srcdir)/parser/main/interface.grm.sig
	-rm -f $(srcdir)/parser/main/interface.lex.sml
	$(MAKESML) -r -o smlsharp

install: $(TARGETS)
	$(INSTALL) -m 755 -d '$(DESTDIR)$(bindir)'
	$(MAKESML) -i -o smlsharp

smlsharp: $(GENSOURCES) PHONY
	MLTON_FLAGS="-verbose 2 -default-ann 'allowFFI true' -cc '$(CXX)' -cc-opt '-xc' $(MLTON_FLAGS)" \
	CXXLDFLAGS='$(CXXLDFLAGS)' \
	MLTON_LIBS='$(LIBS)' \
	$(MAKESML) -t -o $@ $(srcdir)/main/sources.cm

$(srcdir)/builtin/main/BuiltinContextCore.smi.sml: \
        builtin/main/embed.sh builtin/main/BuiltinContextCore.smi
	$(SHELL) $(srcdir)/builtin/main/embed.sh \
	builtin/main/BuiltinContextCore.smi

$(srcdir)/builtin/main/BuiltinContextSQL.smi.sml: \
        builtin/main/embed.sh builtin/main/BuiltinContextSQL.smi
	$(SHELL) $(srcdir)/builtin/main/embed.sh \
	builtin/main/BuiltinContextSQL.smi

$(srcdir)/absyn/main/Absyn.ppg.sml: absyn/main/Absyn.ppg
$(srcdir)/absyn/main/AbsynInterface.ppg.sml: absyn/main/AbsynInterface.ppg
$(srcdir)/absyn/main/AbsynSQL.ppg.sml: absyn/main/AbsynSQL.ppg
$(srcdir)/anormal/main/anormal.ppg.sml: anormal/main/anormal.ppg
$(srcdir)/annotatedtypes/main/AnnotatedTypes.ppg.sml: annotatedtypes/main/AnnotatedTypes.ppg
$(srcdir)/annotatedcalc/main/AnnotatedCalc.ppg.sml: annotatedcalc/main/AnnotatedCalc.ppg
$(srcdir)/assemble/main/AssembleError.ppg.sml: assemble/main/AssembleError.ppg
$(srcdir)/builtin/main/BuiltinPrimitive.ppg.sml: builtin/main/BuiltinPrimitive.ppg
$(srcdir)/builtin/main/BuiltinType.ppg.sml: builtin/main/BuiltinType.ppg
$(srcdir)/idcalc/main/IDCalc.ppg.sml: idcalc/main/IDCalc.ppg
$(srcdir)/bitmapanormal/main/BitmapANormal.ppg.sml: bitmapanormal/main/BitmapANormal.ppg
$(srcdir)/bitmapcalc/main/BitmapCalc.ppg.sml: bitmapcalc/main/BitmapCalc.ppg
$(srcdir)/closureanormal/main/ClosureANormal.ppg.sml: closureanormal/main/ClosureANormal.ppg
$(srcdir)/buccalc/main/BUCCalc.ppg.sml: buccalc/main/BUCCalc.ppg
$(srcdir)/control/main/Control.ppg.sml: control/main/Control.ppg
$(srcdir)/control/main/Loc.ppg.sml: control/main/Loc.ppg
$(srcdir)/usererror/main/UserError.ppg.sml: usererror/main/UserError.ppg
$(srcdir)/clustercalc/main/ClusterCalc.ppg.sml: clustercalc/main/ClusterCalc.ppg
$(srcdir)/elaborate/main/ElaborateError.ppg.sml: elaborate/main/ElaborateError.ppg
$(srcdir)/elaborate/main/ElaborateErrorSQL.ppg.sml: elaborate/main/ElaborateErrorSQL.ppg
$(srcdir)/util/main/SmlppgUtil.ppg.sml: util/main/SmlppgUtil.ppg
$(srcdir)/functionlocalize/main/FunIDMapData.ppg.sml: functionlocalize/main/FunIDMapData.ppg
$(srcdir)/generatemain/main/GenerateMainError.ppg.sml: generatemain/main/GenerateMainError.ppg
$(srcdir)/intermediatelanguage/main/IntermediateLanguage.ppg.sml: intermediatelanguage/main/IntermediateLanguage.ppg
$(srcdir)/loadfile/main/LoadFileError.ppg.sml: loadfile/main/LoadFileError.ppg
$(srcdir)/matchcompilation/main/MatchError.ppg.sml: matchcompilation/main/MatchError.ppg
$(srcdir)/uniqueidallocation/main/PathEnv.ppg.sml: uniqueidallocation/main/PathEnv.ppg
$(srcdir)/uniqueidallocation/main/StaticUniqueIdAllocationEnv.ppg.sml: uniqueidallocation/main/StaticUniqueIdAllocationEnv.ppg
$(srcdir)/multiplevaluecalc/main/MultipleValueCalc.ppg.sml: multiplevaluecalc/main/MultipleValueCalc.ppg
$(srcdir)/multiplevaluecalc/main/MVTypeCheckError.ppg.sml: multiplevaluecalc/main/MVTypeCheckError.ppg
$(srcdir)/patterncalc/main/PatternCalc.ppg.sml: patterncalc/main/PatternCalc.ppg
$(srcdir)/patterncalc/main/PatternCalcInterface.ppg.sml: patterncalc/main/PatternCalcInterface.ppg
$(srcdir)/parser/main/ParserError.ppg.sml: parser/main/ParserError.ppg
$(srcdir)/recordcalc/main/RecordCalc.ppg.sml: recordcalc/main/RecordCalc.ppg
$(srcdir)/symbolicinstructions/main/SymbolicInstructions.ppg.sml: symbolicinstructions/main/SymbolicInstructions.ppg
$(srcdir)/toplevel/main/TopLevelError.ppg.sml: toplevel/main/TopLevelError.ppg
$(srcdir)/typedcalc/main/TypedCalc.ppg.sml: typedcalc/main/TypedCalc.ppg
$(srcdir)/typedlambda/main/TypeCheckTypedLambdaError.ppg.sml: typedlambda/main/TypeCheckTypedLambdaError.ppg
$(srcdir)/typedlambda/main/TypedLambda.ppg.sml: typedlambda/main/TypedLambda.ppg
$(srcdir)/typeinference2/main/TypeInferenceError.ppg.sml: typeinference2/main/TypeInferenceError.ppg
$(srcdir)/typeinference2/main/TypeInferenceContext.ppg.sml: typeinference2/main/TypeInferenceContext.ppg
$(srcdir)/types/main/Types.ppg.sml: types/main/Types.ppg
$(srcdir)/types/main/IDTypes.ppg.sml: types/main/IDTypes.ppg
$(srcdir)/effectcalc/main/EffectCalc.ppg.sml: effectcalc/main/EffectCalc.ppg
$(srcdir)/x86/main/X86Mnemonic.ppg.sml: x86/main/X86Mnemonic.ppg
$(srcdir)/rtl/main/X86Asm.ppg.sml: rtl/main/X86Asm.ppg
$(srcdir)/rtl/main/RTL.ppg.sml: rtl/main/RTL.ppg
$(srcdir)/rtl/main/RTLTypeCheckError.ppg.sml: rtl/main/RTLTypeCheckError.ppg
$(srcdir)/runtimetypes/main/RuntimeTypes.ppg.sml: runtimetypes/main/RuntimeTypes.ppg
$(srcdir)/parser/main/iml.grm.sml $(srcdir)/parser/main/iml.grm.sig $(srcdir)/parser/main/iml.grm.desc: parser/main/iml.grm
$(srcdir)/parser/main/interface.grm.sml $(srcdir)/parser/main/interface.grm.sig $(srcdir)/parser/main/interface.grm.desc: parser/main/interface.grm
$(srcdir)/parser/main/iml.lex.sml: parser/main/iml.lex
