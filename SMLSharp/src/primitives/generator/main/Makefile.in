srcdir = @srcdir@
builddir = @builddir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

include @top_builddir@/commonrule

VPATH = @srcdir@

TEMPLATES = $(srcdir)/../../compiler/main/Primitives.ppg.in \
            $(srcdir)/../../runtime/main/Primitives.cc.in \
            $(srcdir)/../../runtime/main/Primitives.hh.in \
            $(srcdir)/../../../instructions/Instructions.sml.in \
            $(srcdir)/../../compiler/main/Constants.sml.in \
            $(srcdir)/../../runtime/main/Constants.cc.in \
            $(srcdir)/../../runtime/main/Constants.hh.in

TARGETS = $(TEMPLATES:.in=)

SOURCES = Utility.sml \
          SEnv.sml \
          CSVPARSER.sig \
          CSVParser.sml \
          ATMARK_TEMPLATE.sig \
          AtmarkTemplate.sml \
          PRIMITIVE_TABLE.sig \
          PrimitiveTable.sml \
          CONSTANT_TABLE.sig \
          ConstantTable.sml \
          main.sml \
          start.sml

all: $(TARGETS)

$(TARGETS): primgen \
            $(TEMPLATES) \
            $(srcdir)/../../primitives.csv \
            $(srcdir)/../../constants.csv
	./primgen $(srcdir)

primgen: sources.cm $(SOURCES)
	$(MAKESML) -o $@ $(srcdir)/sources.cm

clean:
	-rm -rf $(srcdir)/CM $(srcdir)/.cm
	-rm -f $(TEMPLATES:.in=)
	$(MAKESML) -r -o primgen
