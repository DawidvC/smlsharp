srcdir = @srcdir@
builddir = @builddir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

include @top_builddir@/commonrule

VPATH = @srcdir@

JAVA_SOURCES = \
	./java2sml/org/smlsharp/java2sml/ClassInfo.java \
	./java2sml/org/smlsharp/java2sml/ClassComparator.java \
	./java2sml/org/smlsharp/java2sml/ClassTranslator.java \
	./java2sml/org/smlsharp/java2sml/ConstructorInfo.java \
	./java2sml/org/smlsharp/java2sml/FieldInfo.java \
	./java2sml/org/smlsharp/java2sml/Java2SML.java \
	./java2sml/org/smlsharp/java2sml/MethodInfo.java \
	./java2sml/org/smlsharp/java2sml/MethodInfoComparator.java \
	./java2sml/org/smlsharp/java2sml/NonsupportedMemberException.java \
	./java2sml/org/smlsharp/java2sml/NonsupportedTypeException.java \
	./java2sml/org/smlsharp/java2sml/OverloadedMap.java \
	./java2sml/org/smlsharp/java2sml/OverloadedMethodRenamer.java \
	./java2sml/org/smlsharp/java2sml/OverloadedMethodRenamerByIndex.java \
	./java2sml/org/smlsharp/java2sml/OverloadedMethodRenamerBySignature.java \
	./java2sml/org/smlsharp/java2sml/ParameterInfo.java \
	./java2sml/org/smlsharp/java2sml/PackageInfo.java \
	./java2sml/org/smlsharp/java2sml/SMLCodeGenerator.java \

SOURCES = \
	$(JAVA_SOURCES) \


OBJECTS = $(JAVA_SOURCES:.java=.class)

TARGETS = \
	java2sml.jar \
	bin/java2sml.sh \


JAR_DIR = $(DESTDIR)$(libdir_smlsharp)

all: $(TARGETS)

clean:
	-rm -f $(OBJECTS) $(TARGETS)

install: $(TARGETS) 
	$(INSTALL) -m 755 -d '$(JAR_DIR)'
	$(INSTALL) java2sml.jar '$(JAR_DIR)'
	$(INSTALL) -m 755 -d '$(DESTDIR)$(bindir)'
	$(INSTALL) bin/java2sml.sh '$(DESTDIR)$(bindir)'
	$(INSTALL) -m 755 -d '$(DESTDIR)$(libdir_smlsharp)'/Java
	@set -x; \
	cd $(srcdir)/lib/; \
	find . -type f -print \
	| $(EGREP) -v '\.svn|CVS|\.cvsignore|\~$$|\.in$$|Makefile' \
	| (while read i; do \
	    $(INSTALL_DATA) $$i '$(DESTDIR)$(libdir_smlsharp)/'$$i \
	    || exit $$?; \
	done)

doc:
	-$(MAKE) smldoc

smldoc: 
	@if test 'x$(SMLDOC)' = 'x'; then \
	  echo '*** smldoc not found.'; exit 1; \
	fi
	-rm -rf ./doc/api
	mkdir -p ./doc/api
	$(SMLDOC) -a $(srcdir)/lib/Java/smldoc.cfg

# NOTE: We cannot use -sourcepath flag to specify path to source files, because
# kjc (java compiler) misinterprets this flag. Instead, we change directory to
# the source directory and invoke java compiler there.
java2sml.jar: $(JAVA_SOURCES)
	mkdir -p ./java2sml
	cd $(srcdir) && $(JAVAC) -d $(PWD)/java2sml/ $(JAVA_SOURCES)
	$(JAR) cfm $@ $(srcdir)/java2sml/java2sml.mf -C java2sml org

bin/java2sml.sh: $(srcdir)/bin/java2sml.sh.in
	mkdir -p ./bin
	sed -e "s,%target_os%,$(target_os)," \
	    -e "s,%JAR_DIR%,`$(MKSMLPATH) -sh $(JAR_DIR)`," \
	    -e "s,%JAVA%,$(JAVA)," \
	    $(srcdir)/bin/java2sml.sh.in > $@
