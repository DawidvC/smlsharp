srcdir = @srcdir@
builddir = @builddir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

include @top_builddir@/commonrule

VPATH = @srcdir@

DTOA_CPPFLAGS = -DIEEE_8087 -DMALLOC=xmalloc

LOCAL_DEFS = -DHOST_CPU_i386 -DMAXALIGN=16
LOCAL_CPPFLAGS = -DMINOR_GC
LOCAL_LIBS =

HEAPIMPL_SOURCES = heap_cheney.c heap_bitmap.c heap_otomo.c heap_malloc.c
HEAPIMPL_OBJECTS = $(HEAPIMPL_SOURCES:.c=.$(OBJEXT))
HEAPIMPL = $(NATIVE_HEAPIMPL)
HEAPSOURCES = heap_$(HEAPIMPL).c
HEAPOBJECTS = $(HEAPSOURCES:.c=.$(OBJEXT))

NETLIBSOURCES = netlib/dtoa.c
NETLIBOBJECTS = dtoa.o
LIBSOURCES = error.c obstack.c object.c control.c objspace.c splay.c exn.c \
             prim.c init.c
LIBOBJECTS = $(LIBSOURCES:.c=.$(OBJEXT))

ENTRYSOURCES = main.c
ENTRYOBJECTS = $(ENTRYSOURCES:.c=.$(OBJEXT))

SOURCES = $(HEAPIMPL_SOURCES) $(NETLIBSOURCES) $(LIBSOURCES) $(ENTRYSOURCES)
OBJECTS = $(HEAPIMPL_OBJECTS) $(NETLIBOBJECTS) $(LIBOBJECTS) $(ENTRYOBJECTS)
TARGETS = libsmlsharp.$(LIBEXT) smlsharp_entry.$(OBJEXT)

all: $(TARGETS)

# FIXME: renamed to avoid conflict.
cdepend:
	$(MAKE) $(srcdir)/_cdepend
$(srcdir)/_cdepend: Makefile.in $(SOURCES)
	sed -e '/^##---- depend/q' $(srcdir)/Makefile.in > $@
	for i in $(SOURCES); do \
	  $(CPP) -MM $(DEFS) $(CPPFLAGS) $(srcdir)/$$i \
          | perl -npe 's,^[^:. ]*(\.[^: ]*: *)([^. ]*)\.c,\2\1\2\.c,; \
                       s, /[^ ]*\.h(?= ),,g'; \
	done >> $@
	mv $@ $(srcdir)/Makefile.in

clean:
	-rm -f $(OBJECTS) $(TARGETS)

libsmlsharp.$(LIBEXT): $(HEAPOBJECTS) $(NETLIBOBJECTS) $(LIBOBJECTS)
	-rm -f $@
	$(AR) cru $@ $(HEAPOBJECTS) $(NETLIBOBJECTS) $(LIBOBJECTS)
	-$(RANLIB) $@

smlsharp_entry.$(OBJEXT): $(ENTRYOBJECTS)
	cp $(ENTRYOBJECTS) $@

dtoa.o: netlib/dtoa.c
	$(CC) $(CFLAGS) $(DTOA_CPPFLAGS) $(srcdir)/netlib/dtoa.c -c -o $@

install: $(TARGETS)
	$(INSTALL) -m 755 -d '$(DESTDIR)$(libdir_smlsharp)'
	$(INSTALL_PROGRAM) -m 644 libsmlsharp.$(LIBEXT) '$(DESTDIR)$(libdir_smlsharp)'
	$(INSTALL_PROGRAM) -m 644 smlsharp_entry.$(OBJEXT) '$(DESTDIR)$(libdir_smlsharp)'

##---- dependenices ----##
heap_cheney.o: heap_cheney.c smlsharp.h object.h objspace.h heap.h
heap_bitmap.o: heap_bitmap.c ../../config.h smlsharp.h object.h \
  objspace.h heap.h
heap_otomo.o: heap_otomo.c smlsharp.h object.h objspace.h heap.h \
  heap_otomo.h
heap_malloc.o: heap_malloc.c smlsharp.h objspace.h heap.h
netlib/dtoa.o: netlib/dtoa.c
error.o: error.c smlsharp.h
obstack.o: obstack.c smlsharp.h
object.o: object.c smlsharp.h intinf.h object.h \
  objspace.h heap.h
control.o: control.c smlsharp.h object.h frame.h objspace.h heap.h \
  control.h
objspace.o: objspace.c smlsharp.h object.h control.h objspace.h splay.h
splay.o: splay.c smlsharp.h splay.h
exn.o: exn.c
prim.o: prim.c ../../config.h smlsharp.h intinf.h \
  object.h prim.h
init.o: init.c smlsharp.h objspace.h control.h heap.h
main.o: main.c smlsharp.h
