srcdir = @srcdir@
builddir = @builddir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

include @top_builddir@/commonrule

VPATH = @srcdir@

TEMPLATES = $(srcdir)/../compiler/main/INSTRUCTION_SERIALIZER.sig.in \
            $(srcdir)/../compiler/main/InstructionSerializer.sml.in \
            $(srcdir)/../compiler/main/Instructions.sml.in \
            $(srcdir)/../runtime/main/Instructions.cc.in \
            $(srcdir)/../runtime/main/Instructions.hh.in
YACCFILES = $(srcdir)/Parser.grm
LEXFILES  = $(srcdir)/Tokens.lex

GENSOURCES = $(YACCFILES:.grm=.grm.sml) \
             $(YACCFILES:.grm=.grm.sig) \
             $(YACCFILES:.grm=.grm.desc) \
             $(LEXFILES:.lex=.lex.sml)

TARGETS = $(TEMPLATES:.in=)

DEFINITIONS = $(srcdir)/../Instructions.sml

SOURCES = InstructionParserTypes.sml \
          StringReplacer.sml \
          InstructionGenerator.sml \
          main.sml \
          start.sml \
          $(GENSOURCES)

all: $(TARGETS)

$(TARGETS): insngen $(TEMPLATES) $(DEFINITIONS)
	./insngen $(srcdir)

insngen: sources.cm $(SOURCES)
	$(MAKESML) -o $@ $(srcdir)/sources.cm

clean:
	-rm -rf $(srcdir)/CM $(srcdir)/.cm
	-rm -f $(TEMPLATES:.in=)
	-rm -f $(GENSOURCES)
	$(MAKESML) -r -o insngen

$(srcdir)/Parser.grm.sig $(srcdir)/Parser.grm.sml $(srcdir)/Parser.grm.desc: Parser.grm
$(srcdir)/Tokens.lex.sml: Tokens.lex
