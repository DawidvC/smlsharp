srcdir = @srcdir@
builddir = @builddir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

include @top_builddir@/commonrule

TEMPLATES = $(srcdir)/../compiler/main/INSTRUCTION_SERIALIZER.sig.in \
            $(srcdir)/../compiler/main/InstructionSerializer.sml.in \
            $(srcdir)/../compiler/main/Instructions.sml.in \
            $(srcdir)/../runtime/main/Instructions.cc.in \
            $(srcdir)/../runtime/main/Instructions.hh.in \


TARGETS = $(TEMPLATES:.in=)

DEFINITIONS = $(srcdir)/../Instructions.sml \
              $(srcdir)/../../primitives/primitives.csv \
              $(srcdir)/../../primitives/constants.csv \


all: $(TARGETS)

$(TARGETS): $(TEMPLATES) $(DEFINITIONS)
	cd $(srcdir) && $(SHELL) $(BUILD_ROOT)/mksmlheap --exec 'Main.main();'

clean:
	-rm -rf $(srcdir)/CM $(srcdir)/.cm
	-rm -f $(TEMPLATES:.in=)
	-rm -f $(srcdir)/Parser.grm.sig
	-rm -f $(srcdir)/Parser.grm.sml
	-rm -f $(srcdir)/Parser.grm.desc
	-rm -f $(srcdir)/Tokens.lex.sml
