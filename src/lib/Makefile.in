srcdir = @srcdir@
builddir = @builddir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

include @top_builddir@commonrule

SUBDIRS = basis \
	  FFI \
	  LMLML \
	  Script \
	  SMLSharp \
          CConfig

VPATH = $(srcdir)

TARGETS = prelude.smc

# ./ is required to avoid PATH substitution on Solaris make.
INSTALL_FILES = ./basis \
                ./basis.sml \
                ./FFI \
                ./FFI.sml \
		./LMLML.sml \
		./LMLML \
                ./minimum \
                ./minimum.sml \
                ./ml-yacc \
                ./ml-yacc-lib.sml \
		./prelude.sml \
		./Script \
		./script.sml \
		./smlformatlib.sml \
                ./SMLNJ \
                ./smlnj-lib.sml \
		./smlunitlib.sml \
		./CConfig \
		./SMLSharp \
		./SMLSharp.sml

all: $(TARGETS)

clean:
	-rm -f $(srcdir)/CM
	-rm -f $(TARGETS)
	-rm -f $(srcdir)/smlformatlib.sml $(srcdir)/smlunitlib.sml

config: $(srcdir)/smlformatlib.sml $(srcdir)/smlunitlib.sml

mlton: config

install: $(TARGETS)
	$(INSTALL) -m 755 -d '$(DESTDIR)$(libdir_smlsharp)'
	$(INSTALL_DATA) prelude.smc '$(DESTDIR)$(libdir_smlsharp)'
	@cd $(srcdir); \
	find $(INSTALL_FILES) -type d -print \
	| $(EGREP) -v '\.svn|CVS' \
	| (while read i; do \
	    echo $(INSTALL) -m 755 -d '$(DESTDIR)$(libdir_smlsharp)/'$$i; \
	    $(INSTALL) -m 755 -d '$(DESTDIR)$(libdir_smlsharp)/'$$i \
	  || exit $$?; \
	done)
	@cd $(srcdir); \
	find $(INSTALL_FILES) -type f -print \
	| $(EGREP) -v '\.svn|CVS|\.cvsignore|\~$$|\.in$$|Makefile' \
	| (while read i; do \
	    echo $(INSTALL_DATA) $$i '$(DESTDIR)$(libdir_smlsharp)/'$$i; \
	    $(INSTALL_DATA) $$i '$(DESTDIR)$(libdir_smlsharp)/'$$i \
	    || exit $$?; \
	done)

# ToDO : 
# prelude depends on many files in Basis and other libraries.
prelude.smc: prelude.sml $(SMLSHARP)
	echo ';' | $(SMLSHARP) --prelude=$(srcdir)/prelude.sml --make-compiled-prelude --output=$@ --stdin


$(srcdir)/smlformatlib.sml: smlformatlib.sml.in Makefile \
                            $(top_builddir)mksmlpath
	sed -e "s,%SMLFORMAT_SML%,`$(SHELL) $(top_builddir)mksmlpath -sh '$(SMLFORMATDIR)/smlformatlib.sml'`," \
	    $(srcdir)/smlformatlib.sml.in > $@

$(srcdir)/smlunitlib.sml: smlunitlib.sml.in Makefile \
                          $(top_builddir)mksmlpath
	sed -e "s,%SMLUNIT_SML%,`$(SHELL) $(top_builddir)/mksmlpath -sh '$(SMLUNITDIR)/smlunitlib.sml'`," \
	    $(srcdir)/smlunitlib.sml.in > $@
