#!/bin/sh

HEAPNAME=$1
MAINFUNC=$2
if test -z "$MAINFUNC"; then
  MAINFUNC="Main.main"
fi

script=

if test "x$HEAPNAME" = "x--exec"; then
  script="$script SMLofNJ.Internals.GC.messages false;"
fi

if test "x@NEW_CM@" = "xyes"; then
  SMLFORMATDIR=`$SHELL @abs_top_builddir@/mksmlpath -cm '@SMLFORMATDIR@'`
  BASISDIR=`$SHELL @abs_top_builddir@/mksmlpath -cm '@BASISDIR@'`
  script="$script #set (CM.Anchor.anchor \"smlformatlib.cm\") (SOME \"$SMLFORMATDIR\");"
  script="$script #set (CM.Anchor.anchor \"basis_compat.cm\") (SOME \"$BASISDIR\");"
  script="$script CM.make \"sources.cm\";"
  script="$script if it then () else OS.Process.exit OS.Process.failure;"
else
  script="$script CM.make ();"
fi

if test "x$HEAPNAME" = "x--exec"; then
  script="$script $MAINFUNC;"
else
  case "@target_os@" in
    *cygwin*|*mingw*)
      case "@SML_HEAP_SUFFIX@" in
        *win32*)
          MAINFUNC="(fn (p1, _::ps) => $MAINFUNC (p1, ps))"
          ;;
        *)
      esac
      HEAPNAME=`$SHELL @abs_top_builddir@/mksmlpath "$HEAPNAME"`
      ;;
  esac
  script="$script SMLofNJ.exportFn (\"$HEAPNAME\", $MAINFUNC);"
fi

echo "$script" | @SMLCM@
