# Makefile for SMLDoc
# $Id: Makefile.in,v 1.21 2007/12/13 08:59:46 katsu Exp $

srcdir = @srcdir_smldoc@
builddir = @builddir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

include @top_builddir@/commonrule

VPATH = @srcdir_smldoc@

SMLSHARP = smlsharp

CONFIG_FILES = 


LEXFILES =  $(srcdir)/src/main/ML.lex \
            $(srcdir)/src/main/ParamPattern.lex \
            $(srcdir)/src/main/LinkFile.lex \
            $(srcdir)/src/main/smlnjcm/CM.lex

YACCFILES = $(srcdir)/src/main/ML.grm \
            $(srcdir)/src/main/ParamPattern.grm \
            $(srcdir)/src/main/LinkFile.grm \
            $(srcdir)/src/main/smlnjcm/CM.grm

GENSOURCES = $(LEXFILES:.lex=.lex.sml) \
	     $(YACCFILES:.grm=.grm.sml) \
	     $(YACCFILES:.grm=.grm.sig) \
	     $(YACCFILES:.grm=.grm.desc)

SMLNJ_HEAP = $(srcdir)/src/main/smldoc.$(SML_HEAP_SUFFIX)

TARGET_smlsharp = smldoc
TARGET_smlnj = smldoc
TARGET_mlton = smldoc$(EXEEXT)
MLTON_TARGET_PLATFORM = self
TARGET = $(TARGET_@DEFAULT_SML_COMPILER@)

all: config all-@DEFAULT_SML_COMPILER@

install: install-@DEFAULT_SML_COMPILER@

clean:
	-rm -f $(TARGET_smlsharp) $(SMLNJ_HEAP) $(TARGET_smlnj) $(TARGET_mlton)
	-rm -f $(CONFIG_FILES:.in=)
	-rm -f $(GENSOURCES)
	-rm -rf $(srcdir)/src/main/CM
	-rm -rf $(srcdir)/src/main/.cm

config: $(CONFIG_FILES:.in=)

$(CONFIG_FILES:.in=): Makefile $(CONFIG_FILES)
	sed \
	-e "s|@"SMLFORMATDIR"@|`$(MKSMLPATH) -sh '$(SMLFORMATDIR)'`|g" \
	-e "s|@"SMLUNITDIR"@|`$(MKSMLPATH) -sh '$(SMLUNITDIR)'`|g" \
	$@.in > $@

# -------- Rules for SML# --------

all-smlsharp: $(GENSOURCES)
	$(SMLSHARP) -o $(TARGET_smlsharp) -c src/main/sources.sml

install-smlsharp: install-lib
	$(INSTALL) -m 755 -d '$(DESTDIR)$(bindir)'
	$(INSTALL_PROGRAM) $(TARGET_smlsharp) '$(DESTDIR)$(bindir)'

# -------- Rules for SML/NJ --------

all-smlnj: $(TARGET_smlnj)

$(TARGET_smlnj): $(GENSOURCES)
	cd $(srcdir)/src/main && $(MKSMLHEAP) smldoc
	$(MKSMLRUN) smldoc $(srcdir)/src/main $(TARGET_smlnj)

install-smlnj: install-lib
	$(INSTALL) -m 755 -d '$(DESTDIR)$(bindir)'
	$(INSTALL) -m 755 -d '$(DESTDIR)$(heapdir)'
	$(MKSMLRUN) smldoc $(heapdir) '$(DESTDIR)$(bindir)/smldoc'
	$(INSTALL_DATA) $(SMLNJ_HEAP) '$(DESTDIR)$(heapdir)'

# -------- Rules for MLton --------

all-mlton: $(GENSOURCES)
	$(MLTON) -verbose 1 -output $(TARGET_mlton) \
	         -target $(MLTON_TARGET_PLATFORM) \
	         -cc '$(CC)' $(MLTON_FLAGS) \
	         $(srcdir)/src/mlton/smldoc.mlb

install-mlton: install-lib
	$(INSTALL) -m 755 -d '$(DESTDIR)$(bindir)'
	$(INSTALL_PROGRAM) $(TARGET_mlton) '$(DESTDIR)$(bindir)'

# -------- Common Rules --------

$(GENSOURCES): $(LEXFILES) $(YACCFILES)
	-rm -f $(GENSOURCES)
	@set -x; for i in $(LEXFILES); do $(MLLEX) "$$i"; done
	@set -x; for i in $(YACCFILES); do $(MLYACC) "$$i"; done

install-lib:

# Makefile.in ends here.
