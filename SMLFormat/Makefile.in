# Makefile for SMLFormat
# $Id: Makefile.in,v 1.21 2007/12/13 08:59:46 katsu Exp $

srcdir = @srcdir_smlformat@
builddir = @builddir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

include @top_builddir@/commonrule

VPATH = @srcdir_smlformat@

SMLSHARP = smlsharp

CONFIG_FILES = $(srcdir)/generator/mlton/preludes.mlb.in \
               $(srcdir)/generator/main/sources.sml.in

LIBFILES = smlformatlib.sml \
           formatlib/main

LEXFILES =  $(srcdir)/generator/main/ml.lex

YACCFILES = $(srcdir)/generator/main/ml.grm

GENSOURCES = $(LEXFILES:.lex=.lex.sml) \
             $(YACCFILES:.grm=.grm.sml) \
             $(YACCFILES:.grm=.grm.sig) \
             $(YACCFILES:.grm=.grm.desc)

SMLNJ_HEAP = $(srcdir)/generator/main/smlformat.$(SML_HEAP_SUFFIX)

TARGET_smlsharp = smlformat
TARGET_smlnj = smlformat
TARGET_mlton = smlformat$(EXEEXT)
MLTON_TARGET_PLATFORM = self
TARGET = $(TARGET_@DEFAULT_SML_COMPILER@)

all: config all-@DEFAULT_SML_COMPILER@

install: install-@DEFAULT_SML_COMPILER@

clean:
	-rm -f $(TARGET_smlsharp) $(SMLNJ_HEAP) $(TARGET_smlnj) $(TARGET_mlton)
	-rm -f $(CONFIG_FILES:.in=)
	-rm -f $(GENSOURCES)
	-rm -rf $(srcdir)/generator/main/CM
	-rm -rf $(srcdir)/formatlib/main/CM
	-rm -rf $(srcdir)/generator/main/.cm
	-rm -rf $(srcdir)/formatlib/main/.cm
	-rm -f cmtool/anchor.sml cmtool/ppg-ext.cm cmtool/smlformat-tool.sml
	-rm -rf cmtool/.cm
	-rmdir cmtool

config: $(CONFIG_FILES:.in=)

$(CONFIG_FILES:.in=): Makefile $(CONFIG_FILES)
	sed \
	-e "s|@"SMLFORMATDIR"@|`$(MKSMLPATH) -sh '$(SMLFORMATDIR)'`|g" \
	-e "s|@"SMLUNITDIR"@|`$(MKSMLPATH) -sh '$(SMLUNITDIR)'`|g" \
	$@.in > $@

cmtool_ppg: cmtool/anchor.sml cmtool/ppg-ext.cm cmtool/smlformat-tool.sml

cmtool/anchor.sml cmtool/ppg-ext.cm cmtool/smlformat-tool.sml: \
	cmtool/anchor.sml.in cmtool/ppg-ext.cm.in cmtool/smlformat-tool.sml.in
	-mkdir cmtool
	for i in cmtool/anchor.sml cmtool/ppg-ext.cm cmtool/smlformat-tool.sml;\
	do \
	  sed \
	  -e "s|@"CMTOOLDIR"@|`$(MKSMLPATH) -cm "$$PWD/cmtool"`|g" \
	  -e "s|@"SMLFORMAT"@|`$(MKSMLPATH) -cm "$$PWD/$(TARGET)"`|g" \
	  $(srcdir)/"$$i".in > "$$i"; \
	done

# -------- Rules for SML# --------

all-smlsharp: $(GENSOURCES)
	$(SMLSHARP) -o $(TARGET_smlsharp) -c generator/main/sources.sml

install-smlsharp: install-lib
	$(INSTALL) -m 755 -d '$(DESTDIR)$(bindir)'
	$(INSTALL_PROGRAM) $(TARGET_smlsharp) '$(DESTDIR)$(bindir)'

# -------- Rules for SML/NJ --------

all-smlnj: $(TARGET_smlnj) cmtool_ppg

$(TARGET_smlnj): $(GENSOURCES)
	cd $(srcdir)/generator/main && $(MKSMLHEAP) smlformat
	$(MKSMLRUN) smlformat $(srcdir)/generator/main $(TARGET_smlnj)

install-smlnj: install-lib
	$(INSTALL) -m 755 -d '$(DESTDIR)$(bindir)'
	$(INSTALL) -m 755 -d '$(DESTDIR)$(heapdir)'
	$(MKSMLRUN) smlformat $(heapdir) '$(DESTDIR)$(bindir)/smlformat'
	$(INSTALL_DATA) $(SMLNJ_HEAP) '$(DESTDIR)$(heapdir)'

# -------- Rules for MLton --------

all-mlton: $(GENSOURCES)
	$(MLTON) -verbose 1 -output $(TARGET_mlton) \
	         -target $(MLTON_TARGET_PLATFORM) \
	         -cc '$(CC)' $(MLTON_FLAGS) \
	         $(srcdir)/generator/mlton/smlformat.mlb

install-mlton: install-lib
	$(INSTALL) -m 755 -d '$(DESTDIR)$(bindir)'
	$(INSTALL_PROGRAM) $(TARGET_mlton) '$(DESTDIR)$(bindir)'

# -------- Common Rules --------

$(GENSOURCES): $(LEXFILES) $(YACCFILES)
	-rm -f $(GENSOURCES)
	@set -x; for i in $(LEXFILES); do $(MLLEX) "$$i"; done
	@set -x; for i in $(YACCFILES); do $(MLYACC) "$$i"; done

install-lib:
	$(INSTALL) -m 755 -d '$(DESTDIR)$(libdir_smlformat)'
	@set -x; \
	cd $(srcdir); \
	find $(LIBFILES) -type d -print \
	| $(EGREP) -v '\.svn|CVS|CM|\.cm' \
	| (while read i; do \
	    $(INSTALL) -m 755 -d '$(DESTDIR)$(libdir_smlformat)/'$$i \
	    || exit $$?; \
	   done)
	@set -x; \
	cd $(srcdir); \
	find $(LIBFILES) -type f -print \
	| $(EGREP) -v '\.svn|CVS|\.cvsignore|\~$$|\.in$$|Makefile|CM|\.cm' \
	| (while read i; do \
	    $(INSTALL_DATA) $$i '$(DESTDIR)$(libdir_smlformat)/'$$i \
	    || exit $$?; \
	   done);
	if test 'x$(libdir_smlsharp)' != 'x'; then \
	  set -x; \
	  echo "use \"`$(MKSMLPATH) -sh $(libdir_smlformat)/smlformatlib.sml`\";" > '$(DESTDIR)$(libdir_smlsharp)/smlformatlib.sml'; \
	fi

# Makefile.in ends here.
