# Makefile for SMLFormat
# $Id: Makefile.in,v 1.2 2006/02/21 13:48:53 katsuu Exp $

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=$(exec_prefix)/bin
libdir=$(prefix)/share/smlformat
DESTDIR=

INSTALL=install
SML=@SMLCM@
SML_CMD=@SML@
MAINFUNC=@MAINFUNC@
HEAPNAME=@HEAPNAME@

TARGETS = bin/smlformat 

all: $(TARGETS)

clean:
	-rm -f $(TARGETS)
	-rm -rf generator/main/CM formatlib/main/CM formatlib/test/CM

# Since the filename of heap file generated by exportFn cannot be detected
# easily, we cannot write a make-rule for the heap file.
# So, we make a rule for bin/smlformat delegate a rule for the heap file.

bin/smlformat: Makefile
	$(MAKE) heap
	echo "#!/bin/sh" > $@
	echo "SML='$(SML_CMD)'" >> $@
	echo "HEAPNAME='$(HEAPNAME)'" >> $@
	echo 'exec "$$SML" @SMLload="$$HEAPNAME" "$$@"' >> $@
	chmod +x $@

heap:
	cd generator/main && \
	echo "CM.make();" \
	     "SMLofNJ.exportFn(\"$(HEAPNAME)\",$(MAINFUNC));" \
	| $(SML)

test:
	cd formatlib/test && \
	echo "SMLofNJ.Internals.GC.messages false;" \
	     "CM.make();" \
	     "TestMain.test();" \
	| $(SML_CMD)

#install: $(TARGETS)
#	$(INSTALL) -m 755 -d $(DESTDIR)$(bindir)
#	$(INSTALL) -m 755 bin/smlformat $(DESTDIR)$(bindir)
#	$(INSTALL) -m 755 -d $(DESTDIR)$(libdir)
#	$(INSTALL) -m 644 smlformatlib.cm $(DESTDIR)$(libdir)
#	$(INSTALL) -m 755 -d $(DESTDIR)$(libdir)/formatlib/main
#	@find formatlib/main -type f | grep -v CVS | grep -v '^\.' | \
#	(while read i; do \
#	  echo $(INSTALL) -m 644 $$i $(DESTDIR)$(libdir)/formatlib/main; \
#	  $(INSTALL) -m 644 $$i $(DESTDIR)$(libdir)/formatlib/main; \
#	done)
